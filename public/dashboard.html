<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Active Calls</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="/styles/monitor.css">
</head>
<body>
    <div class="top-bar">
        <a href="/dashboard.html" class="top-bar-title-link"><h1 class="top-bar-title">AI Active Calls</h1></a>
        <div class="top-bar-right">
            <div class="connection-status" id="connectionStatus">
                <span class="status-dot"></span>
                <span class="status-text">Connecting...</span>
            </div>
            <span class="user-email" id="userEmailDash">-</span>
            <button class="logout-btn" onclick="logout()">Sign Out</button>
        </div>
    </div>
    
    <div class="dashboard-container authenticated">
        <div class="dashboard-content">
            <div class="dashboard-controls">
                <div class="left-controls">
                    <div class="filters-container">
                    <!-- Workflow Status Filter -->
                    <div class="filter-group">
                        <label class="filter-label">Status:</label>
                        <div class="dropdown-filter">
                            <button class="dropdown-toggle" id="statusFilterToggle">
                                <span class="filter-text">All Statuses</span>
                                <span class="dropdown-arrow">‚ñº</span>
                            </button>
                            <div class="dropdown-menu" id="statusFilterMenu">
                                <label class="dropdown-item">
                                    <input type="checkbox" value="all" checked> All
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="pending"> Pending
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="new"> New
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="checking_classification"> Checking Classification
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="needs_classification"> Needs Classification
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="classifying"> Classifying
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="classification_pending"> Classification Pending
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="ready_to_call"> Ready to Call
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="calling"> Calling
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="retry_pending"> Retry Pending
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="completed"> Completed
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="failed"> Failed
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Appointment Range Filter -->
                    <div class="filter-group">
                        <label class="filter-label">Appointment Range:</label>
                        <div class="dropdown-filter">
                            <button class="dropdown-toggle" id="dateFilterToggle">
                                <span class="filter-text">Last 6 Months</span>
                                <span class="dropdown-arrow">‚ñº</span>
                            </button>
                            <div class="dropdown-menu" id="dateFilterMenu">
                                <label class="dropdown-item">
                                    <input type="checkbox" value="last6months" checked> Last 6 Months
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="today"> Today
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="tomorrow"> Tomorrow
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="yesterday"> Yesterday
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="last7days"> Last 7 Days
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="last30days"> Last 30 Days
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="older30days"> Older than 30 Days
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="alltime"> All Time
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Task Type Filter -->
                    <div class="filter-group">
                        <label class="filter-label">Task:</label>
                        <div class="dropdown-filter">
                            <button class="dropdown-toggle" id="taskFilterToggle">
                                <span class="filter-text">All Tasks</span>
                                <span class="dropdown-arrow">‚ñº</span>
                            </button>
                            <div class="dropdown-menu" id="taskFilterMenu">
                                <label class="dropdown-item">
                                    <input type="checkbox" value="all" checked> All Tasks
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="records_request"> Records Request
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="schedule"> Schedule
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="kit_confirmation"> Kit Confirmation
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Active/Inactive Filter -->
                    <div class="filter-group">
                        <label class="filter-label">Archive:</label>
                        <div class="dropdown-filter">
                            <button class="dropdown-toggle" id="activeFilterToggle">
                                <span class="filter-text">Active Only</span>
                                <span class="dropdown-arrow">‚ñº</span>
                            </button>
                            <div class="dropdown-menu" id="activeFilterMenu">
                                <label class="dropdown-item">
                                    <input type="checkbox" value="active" checked> Active
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="inactive"> Inactive
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Success Evaluation Filter -->
                    <div class="filter-group">
                        <label class="filter-label">Outcome:</label>
                        <div class="dropdown-filter">
                            <button class="dropdown-toggle" id="successFilterToggle">
                                <span class="filter-text">All Outcomes</span>
                                <span class="dropdown-arrow">‚ñº</span>
                            </button>
                            <div class="dropdown-menu" id="successFilterMenu">
                                <label class="dropdown-item">
                                    <input type="checkbox" value="all" checked> All
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="Sending Records"> Sending Records
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="No Show"> No Show
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="Already Sent"> Already Sent
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="Policy Restriction"> Policy Restriction
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="Insufficient Information"> Insufficient Information
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="Requested to call back"> Requested to call back
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="Unable to connect"> Unable to connect
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="none"> None (blank)
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Row Limit Selector -->
                    <div class="filter-group">
                        <label class="filter-label">Show:</label>
                        <div class="dropdown-filter">
                            <button class="dropdown-toggle" id="rowLimitToggle">
                                <span class="filter-text">50 rows</span>
                                <span class="dropdown-arrow">‚ñº</span>
                            </button>
                            <div class="dropdown-menu" id="rowLimitMenu">
                                <label class="dropdown-item">
                                    <input type="radio" name="rowLimit" value="10"> 10 rows
                                </label>
                                <label class="dropdown-item">
                                    <input type="radio" name="rowLimit" value="50" checked> 50 rows
                                </label>
                                <label class="dropdown-item">
                                    <input type="radio" name="rowLimit" value="100"> 100 rows
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                    <!-- Filter Presets Section -->
                    <div class="filter-presets-section">
                        <button class="save-filter-btn" onclick="showSaveFilterModal()">Save Filter</button>
                        <div class="saved-presets" id="savedPresets">
                            <!-- Saved filter presets will appear here -->
                        </div>
                    </div>
                </div>
                
                <!-- Search Section -->
                <div class="search-section">
                    <div style="display: flex; gap: 10px;">
                        <button class="refresh-btn new-call-btn" onclick="showNewCallModal()">+ New Call</button>
                        <button class="refresh-btn new-call-btn" onclick="showImportModal()">üìÅ Import Calls</button>
                        <button class="refresh-btn new-call-btn" onclick="showColumnToggleModal()">‚öôÔ∏è Columns</button>
                    </div>
                    <div class="search-container">
                        <input type="text" id="searchInput" placeholder="Search calls..." class="search-input">
                        <button class="search-clear" id="searchClear" onclick="clearSearch()" style="display: none;">&times;</button>
                    </div>
                </div>
                
                <!-- Buttons hidden for production
                <button class="refresh-btn" onclick="loadPendingCalls()">Refresh</button>
                <button class="refresh-btn" onclick="testRealtimeConnection()" style="margin-left: 10px;">Test Realtime</button>
                -->
            </div>

            <!-- Batch Actions Bar -->
            <div id="batchActionsBar" class="batch-actions-bar" style="display: none;">
                <div class="batch-info">
                    <span id="selectedCount">0</span> selected
                </div>
                <div class="batch-buttons">
                    <button class="batch-btn batch-play" onclick="batchMakeCalls()" title="Make calls for selected rows">
                        <svg class="batch-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 5v14l11-7L8 5z" fill="currentColor"/>
                        </svg>
                        Play
                    </button>
                    <button class="batch-btn batch-archive" onclick="batchArchive()" title="Archive selected rows">
                        <svg class="batch-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20.54 5.23l-1.39-1.68C18.88 3.21 18.47 3 18 3H6c-.47 0-.88.21-1.16.55L3.46 5.23C3.17 5.57 3 6.02 3 6.5V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6.5c0-.48-.17-.93-.46-1.27zM12 17.5L6.5 12H10v-2h4v2h3.5L12 17.5zM5.12 5l.81-1h12l.94 1H5.12z" fill="currentColor"/>
                        </svg>
                        Archive
                    </button>
                    <button class="batch-btn batch-delete" onclick="batchDelete()" title="Delete selected rows">
                        <svg class="batch-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" fill="currentColor"/>
                        </svg>
                        Delete
                    </button>
                    <button class="batch-btn batch-cancel" onclick="clearSelection()">
                        Cancel
                    </button>
                </div>
            </div>

            <div class="calls-table">
                <table>
                    <thead>
                        <tr>
                            <th class="checkbox-col">
                                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this.checked)" title="Select all visible rows">
                            </th>
                            <th>Actions</th>
                            <th data-sort="employee_name" class="sortable" data-column="employee">Employee <span class="sort-arrow"></span></th>
                            <th data-sort="appointment_time" class="sortable" data-column="appointment">Appointment <span class="sort-arrow"></span></th>
                            <th data-sort="task_type" class="sortable" data-column="task">Task <span class="sort-arrow"></span></th>
                            <th data-sort="workflow_state" class="sortable" data-column="status">Status <span class="sort-arrow"></span></th>
                            <th data-sort="success_evaluation" class="sortable" data-column="success">Success Evaluation <span class="sort-arrow"></span></th>
                            <th data-sort="retry_count" class="sortable" data-column="retries">Retries <span class="sort-arrow"></span></th>
                            <th data-sort="client_name" class="sortable" data-column="client">Client <span class="sort-arrow"></span></th>
                            <th data-sort="clinic_name" class="sortable" data-column="clinic">Clinic <span class="sort-arrow"></span></th>
                            <th data-sort="phone" class="sortable" data-column="phone">Phone <span class="sort-arrow"></span></th>
                            <th data-sort="procedures" class="sortable" data-column="procedures">Procedures <span class="sort-arrow"></span></th>
                            <th data-sort="clinic_provider_address" class="sortable" data-column="address">Clinic Address <span class="sort-arrow"></span></th>
                            <th data-column="classification">Classification</th>
                            <th data-column="last_error">Last Error</th>
                            <th data-sort="last_attempt_at" class="sortable" data-column="last_try">Last Try <span class="sort-arrow"></span></th>
                            <th data-sort="next_action_at" class="sortable" data-column="next">Next <span class="sort-arrow"></span></th>
                            <th data-column="tags">Tags</th>
                        </tr>
                    </thead>
                    <tbody id="callsTableBody">
                        <tr>
                            <td colspan="18" class="empty-table">Loading calls...</td>
                        </tr>
                    </tbody>
                </table>

                <!-- Show More Button -->
                <div class="show-more-container" style="text-align: center; padding: 20px; display: none;">
                    <button class="show-more-btn" onclick="loadMoreCalls()">
                        <span class="btn-text">Show More</span>
                        <span class="btn-subtext" id="showMoreCount">(Load 50 more)</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Save Filter Modal -->
    <div id="saveFilterModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Save Filter Preset</h3>
                <button class="modal-close" onclick="closeSaveFilterModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Give this filter combination a name:</p>
                <input type="text" id="filterPresetName" placeholder="e.g., Today's Failed Calls" maxlength="50">
                <div class="current-filters-preview" id="currentFiltersPreview">
                    <!-- Current filter summary will appear here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeSaveFilterModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveFilterPreset()">Save Preset</button>
            </div>
        </div>
    </div>

    <!-- Classification Editor Modal -->
    <div id="classificationModal" class="modal" style="display: none;">
        <div class="modal-content classification-modal-content">
            <div class="modal-header">
                <h3 id="classificationModalTitle">Edit Call</h3>
                <button class="modal-close" onclick="closeClassificationModal()">&times;</button>
            </div>
            <div class="modal-tabs">
                <button class="modal-tab active" onclick="switchEditTab('call')">Edit Call</button>
                <button class="modal-tab" onclick="switchEditTab('classification')">Edit Classification</button>
            </div>
            <div class="modal-body">
                <!-- Tab 1: Edit Call -->
                <div id="editCallTab" class="edit-tab-content">
                    <div class="classification-form">
                        <!-- Employee Information -->
                        <div class="form-section">
                            <h4>Employee Information</h4>
                            <div class="form-group">
                                <label>Exam ID*</label>
                                <input type="text" id="editCallExamId" placeholder="Enter exam ID" required>
                            </div>
                            <div class="form-group">
                                <label>Employee Name*</label>
                                <input type="text" id="editCallEmployeeName" placeholder="Enter employee name" required>
                            </div>
                            <div class="form-group">
                                <label>Employee Date of Birth*</label>
                                <input type="date" id="editCallEmployeeDob" required>
                            </div>
                            <div class="form-group">
                                <label>Client Name*</label>
                                <input type="text" id="editCallClientName" placeholder="Enter client name" required>
                            </div>
                        </div>

                        <!-- Appointment Information -->
                        <div class="form-section">
                            <h4>Appointment Information</h4>
                            <div class="form-group">
                                <label>Appointment Time*</label>
                                <input type="datetime-local" id="editCallAppointmentTime" required>
                            </div>
                            <div class="form-group">
                                <label>Type of Visit*</label>
                                <select id="editCallTypeOfVisit" required>
                                    <option value="">Select type...</option>
                                    <option value="appointment">Appointment</option>
                                    <option value="walk-in">Walk-in</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Procedures</label>
                                <textarea id="editCallProcedures" placeholder="Enter procedures" rows="3"></textarea>
                            </div>
                        </div>

                        <!-- Clinic Information -->
                        <div class="form-section">
                            <h4>Clinic Information</h4>
                            <div class="form-group">
                                <label>Clinic Name*</label>
                                <input type="text" id="editCallClinicName" placeholder="Enter clinic name" required>
                            </div>
                            <div class="form-group">
                                <label>Clinic Phone Number*</label>
                                <input type="tel" id="editCallPhone" placeholder="+16095550123" required>
                                <small style="color: #666; font-size: 12px;">Format: +16095550123</small>
                            </div>
                            <div class="form-group">
                                <label>Clinic Provider Address</label>
                                <input type="text" id="editCallClinicAddress" placeholder="Enter clinic address">
                            </div>
                            <div class="form-group">
                                <label>Clinic Timezone*</label>
                                <select id="editCallClinicTimezone" required>
                                    <option value="America/New_York">Eastern (America/New_York)</option>
                                    <option value="America/Chicago">Central (America/Chicago)</option>
                                    <option value="America/Denver">Mountain (America/Denver)</option>
                                    <option value="America/Los_Angeles">Pacific (America/Los_Angeles)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Task Information -->
                        <div class="form-section">
                            <h4>Task Information</h4>
                            <div class="form-group">
                                <label>Task Type*</label>
                                <select id="editCallTaskType" required>
                                    <option value="records_request">Records Request</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab 2: Edit Classification -->
                <div id="editClassificationTab" class="edit-tab-content" style="display: none;">
                <div class="classification-form">
                    <!-- Basic Info -->
                    <div class="form-section">
                        <h4>Call Information</h4>
                        <div class="form-group">
                            <label>Phone Number*</label>
                            <input type="text" id="classificationPhone" placeholder="+1234567890" required>
                        </div>
                        <div class="form-group">
                            <label>Clinic Name</label>
                            <input type="text" id="classificationClinicName" placeholder="Enter clinic name">
                        </div>
                    </div>

                    <!-- Classification Type -->
                    <div class="form-section">
                        <h4>Classification Type*</h4>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="classificationType" value="human">
                                <div class="radio-content">
                                    <span class="radio-label">Human</span>
                                    <span class="radio-desc">Direct human answer, no IVR</span>
                                </div>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="classificationType" value="ivr_only">
                                <div class="radio-content">
                                    <span class="radio-label">IVR Only</span>
                                    <span class="radio-desc">Full IVR system requiring navigation</span>
                                </div>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="classificationType" value="ivr_then_human">
                                <div class="radio-content">
                                    <span class="radio-label">IVR Then Human</span>
                                    <span class="radio-desc">IVR greeting then transfers to human</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- IVR Actions (shown only for ivr_only and ivr_then_human) -->
                    <div class="form-section" id="ivrActionsSection" style="display: none;">
                        <h4>IVR Actions</h4>
                        <p class="section-description">Define the navigation sequence through the IVR menu</p>
                        <div id="ivrActionsList"></div>
                        <button type="button" class="add-action-btn" onclick="addIvrAction()">+ Add Action</button>
                    </div>

                    <!-- Confidence Score -->
                    <div class="form-section">
                        <h4>Confidence Score</h4>
                        <div class="form-group">
                            <input type="range" id="classificationConfidence" min="0" max="1" step="0.05" value="0.95">
                            <span id="confidenceValue">0.95</span>
                        </div>
                    </div>
                </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeClassificationModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveEditModal()" id="saveEditBtn">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- New Pending Call Modal -->
    <div id="newCallModal" class="modal" style="display: none;">
        <div class="modal-content classification-modal-content">
            <div class="modal-header">
                <h3>New Pending Call</h3>
                <button class="modal-close" onclick="closeNewCallModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="classification-form">
                    <!-- Employee Information -->
                    <div class="form-section">
                        <h4>Employee Information</h4>
                        <div class="form-group">
                            <label>Exam ID*</label>
                            <input type="text" id="newCallExamId" placeholder="Enter exam ID" required>
                        </div>
                        <div class="form-group">
                            <label>Employee Name*</label>
                            <input type="text" id="newCallEmployeeName" placeholder="Enter employee name" required>
                        </div>
                        <div class="form-group">
                            <label>Employee Date of Birth*</label>
                            <input type="date" id="newCallEmployeeDob" required>
                        </div>
                        <div class="form-group">
                            <label>Client Name*</label>
                            <input type="text" id="newCallClientName" placeholder="Enter client name" required>
                        </div>
                    </div>

                    <!-- Appointment Information -->
                    <div class="form-section">
                        <h4>Appointment Information</h4>
                        <div class="form-group">
                            <label>Appointment Time*</label>
                            <input type="datetime-local" id="newCallAppointmentTime" required>
                        </div>
                        <div class="form-group">
                            <label>Type of Visit*</label>
                            <select id="newCallTypeOfVisit" required>
                                <option value="">Select type...</option>
                                <option value="appointment">Appointment</option>
                                <option value="walk-in">Walk-in</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Procedures</label>
                            <textarea id="newCallProcedures" placeholder="Enter procedures" rows="3"></textarea>
                        </div>
                    </div>

                    <!-- Clinic Information -->
                    <div class="form-section">
                        <h4>Clinic Information</h4>
                        <div class="form-group">
                            <label>Clinic Name*</label>
                            <input type="text" id="newCallClinicName" placeholder="Enter clinic name" required>
                        </div>
                        <div class="form-group">
                            <label>Clinic Phone Number*</label>
                            <input type="tel" id="newCallPhone" placeholder="+16095550123" required>
                            <small style="color: #666; font-size: 12px;">Format: +16095550123</small>
                        </div>
                        <div class="form-group">
                            <label>Clinic Provider Address</label>
                            <input type="text" id="newCallClinicAddress" placeholder="Enter clinic address">
                        </div>
                        <div class="form-group">
                            <label>Clinic Timezone*</label>
                            <select id="newCallClinicTimezone" required>
                                <option value="America/New_York">Eastern (America/New_York)</option>
                                <option value="America/Chicago">Central (America/Chicago)</option>
                                <option value="America/Denver">Mountain (America/Denver)</option>
                                <option value="America/Los_Angeles">Pacific (America/Los_Angeles)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Task Information -->
                    <div class="form-section">
                        <h4>Task Information</h4>
                        <div class="form-group">
                            <label>Task Type*</label>
                            <select id="newCallTaskType" required>
                                <option value="records_request">Records Request</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeNewCallModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveNewCall()" id="saveNewCallBtn">Create Call</button>
            </div>
        </div>
    </div>

    <!-- Import Calls Modal -->
    <div id="importModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
            <div class="modal-header">
                <h3 id="importModalTitle">Import Calls</h3>
                <button class="modal-close" onclick="closeImportModal()">&times;</button>
            </div>
            <div class="modal-body" style="overflow-y: auto;">

                <!-- Step 1: File Upload -->
                <div id="importStep1" class="import-step">
                    <h4>Step 1: Upload File</h4>
                    <p style="color: #666; margin-bottom: 16px;">Upload an .xlsx or .csv file containing call data</p>
                    <div class="file-upload-area" id="fileUploadArea">
                        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;" onchange="handleFileUpload(event)">
                        <div class="upload-prompt" onclick="document.getElementById('fileInput').click()">
                            <div style="font-size: 48px; margin-bottom: 12px;">üìÅ</div>
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Click to browse or drag & drop</div>
                            <div style="font-size: 14px; color: #666;">Supports .xlsx, .xls, .csv files</div>
                        </div>
                    </div>
                    <div id="fileInfo" style="display: none; margin-top: 16px; padding: 12px; background: #f0f9ff; border-radius: 6px; border: 1px solid #bae6fd;">
                        <div style="font-weight: 600; margin-bottom: 4px;">File loaded:</div>
                        <div id="fileName" style="color: #666;"></div>
                        <div id="fileStats" style="color: #666; margin-top: 4px;"></div>
                    </div>
                </div>

                <!-- Step 2: Column Mapping -->
                <div id="importStep2" class="import-step" style="display: none;">
                    <h4>Step 2: Map Columns</h4>
                    <p style="color: #666; margin-bottom: 16px;">Match your file columns to database fields</p>
                    <div id="columnMappingContainer"></div>
                </div>

                <!-- Processing Step (shown while detecting timezones) -->
                <div id="importStepProcessing" class="import-step" style="display: none;">
                    <div style="text-align: center; padding: 48px 24px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üåç</div>
                        <h4 style="margin-bottom: 8px;">Processing Data...</h4>
                        <p id="processingMessage" style="color: #666;">Detecting timezones from addresses...</p>
                    </div>
                </div>

                <!-- Step 3: Row Selection -->
                <div id="importStep3" class="import-step" style="display: none;">
                    <h4>Step 3: Select Rows to Import</h4>
                    <p style="color: #666; margin-bottom: 16px;">Choose which rows you want to import</p>
                    <div style="margin-bottom: 12px;">
                        <button class="modal-btn secondary" onclick="selectAllRows()">Select All</button>
                        <button class="modal-btn secondary" onclick="selectNoneRows()">Select None</button>
                        <span id="selectionCount" style="margin-left: 12px; color: #666;"></span>
                    </div>
                    <div id="rowSelectionContainer" style="max-height: 400px; overflow-y: auto;"></div>
                </div>

                <!-- Step 4: Preview -->
                <div id="importStep4" class="import-step" style="display: none;">
                    <h4>Step 4: Preview & Validate</h4>
                    <p style="color: #666; margin-bottom: 16px;">Review data before importing</p>
                    <div id="validationSummary" style="margin-bottom: 16px;"></div>
                    <div id="previewContainer" style="max-height: 400px; overflow-y: auto;"></div>
                </div>

                <!-- Step 5: Import Progress -->
                <div id="importStep5" class="import-step" style="display: none;">
                    <h4>Importing...</h4>
                    <div id="importProgress" style="margin: 32px 0;">
                        <div style="background: #e5e7eb; border-radius: 8px; height: 24px; overflow: hidden; margin-bottom: 12px;">
                            <div id="progressBar" style="background: #10b981; height: 100%; width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <div id="progressText" style="text-align: center; color: #666;"></div>
                    </div>
                    <div id="importResults" style="display: none;"></div>
                </div>

            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" id="importBackBtn" onclick="importPreviousStep()" style="display: none;">Back</button>
                <button class="modal-btn secondary" onclick="closeImportModal()">Cancel</button>
                <button class="modal-btn primary" id="importNextBtn" onclick="importNextStep()">Next</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Delete Call</h3>
                <button class="modal-close" onclick="closeDeleteConfirmation()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; padding: 24px 16px;">
                    <div style="font-size: 48px; color: #dc2626; margin-bottom: 16px;">‚ö†Ô∏è</div>
                    <h4 style="margin: 0 0 8px 0; color: #1f2937;">Are you sure you want to delete this call?</h4>
                    <p id="deleteCallInfo" style="margin: 8px 0 0 0; color: #666; font-size: 14px;"></p>
                    <p style="margin: 16px 0 0 0; color: #dc2626; font-weight: 600; font-size: 14px;">This action cannot be undone.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeDeleteConfirmation()">Cancel</button>
                <button class="modal-btn primary" id="confirmDeleteBtn" onclick="confirmDeleteCall()" style="background-color: #dc2626;">Delete</button>
            </div>
        </div>
    </div>

    <!-- Column Toggle Modal -->
    <div id="columnToggleModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Show/Hide Columns</h3>
                <button class="modal-close" onclick="closeColumnToggleModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: #666; margin-bottom: 16px;">Select which columns to display in the table:</p>
                <div class="column-toggle-grid">
                    <label class="column-toggle-item">
                        <input type="checkbox" data-column="employee" checked> Employee
                    </label>
                    <label class="column-toggle-item">
                        <input type="checkbox" data-column="appointment" checked> Appointment
                    </label>
                    <label class="column-toggle-item">
                        <input type="checkbox" data-column="task" checked> Task
                    </label>
                    <label class="column-toggle-item">
                        <input type="checkbox" data-column="status" checked> Status
                    </label>
                    <label class="column-toggle-item">
                        <input type="checkbox" data-column="success" checked> Success Evaluation
                    </label>
                    <label class="column-toggle-item">
                        <input type="checkbox" data-column="retries" checked> Retries
                    </label>
                    <label class="column-toggle-item">
                        <input type="checkbox" data-column="client" checked> Client
                    </label>
                    <label class="column-toggle-item">
                        <input type="checkbox" data-column="clinic" checked> Clinic
                    </label>
                    <label class="column-toggle-item">
                        <input type="checkbox" data-column="phone" checked> Phone
                    </label>
                    <label class="column-toggle-item">
                        <input type="checkbox" data-column="procedures"> Procedures
                    </label>
                    <label class="column-toggle-item">
                        <input type="checkbox" data-column="address"> Clinic Address
                    </label>
                    <label class="column-toggle-item">
                        <input type="checkbox" data-column="classification"> Classification
                    </label>
                    <label class="column-toggle-item">
                        <input type="checkbox" data-column="last_error"> Last Error
                    </label>
                    <label class="column-toggle-item">
                        <input type="checkbox" data-column="last_try" checked> Last Try
                    </label>
                    <label class="column-toggle-item">
                        <input type="checkbox" data-column="next" checked> Next
                    </label>
                    <label class="column-toggle-item">
                        <input type="checkbox" data-column="tags" checked> Tags
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="resetColumnVisibility()">Reset to Default</button>
                <button class="modal-btn primary" onclick="applyColumnVisibility()">Apply</button>
            </div>
        </div>
    </div>

    <!-- Batch Archive Confirmation Modal -->
    <div id="batchArchiveModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Archive Calls</h3>
                <button class="modal-close" onclick="closeBatchArchiveModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; padding: 24px 16px;">
                    <div style="font-size: 48px; margin-bottom: 16px;">üì¶</div>
                    <h4 style="margin: 0 0 8px 0; color: #1f2937;">Archive <span id="archiveCount"></span> call(s)?</h4>
                    <p style="margin: 8px 0 0 0; color: #666; font-size: 14px;">Archived calls can be restored later from the Archive filter.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeBatchArchiveModal()">Cancel</button>
                <button class="modal-btn primary" onclick="confirmBatchArchive()">Archive</button>
            </div>
        </div>
    </div>

    <!-- Batch Delete Confirmation Modal -->
    <div id="batchDeleteModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Delete Calls</h3>
                <button class="modal-close" onclick="closeBatchDeleteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; padding: 24px 16px;">
                    <div style="font-size: 48px; color: #dc2626; margin-bottom: 16px;">‚ö†Ô∏è</div>
                    <h4 style="margin: 0 0 8px 0; color: #1f2937;">Delete <span id="deleteCount"></span> call(s)?</h4>
                    <p style="margin: 16px 0 0 0; color: #dc2626; font-weight: 600; font-size: 14px;">This action cannot be undone.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeBatchDeleteModal()">Cancel</button>
                <button class="modal-btn primary" onclick="confirmBatchDelete()" style="background-color: #dc2626;">Delete</button>
            </div>
        </div>
    </div>

    <!-- Batch Make Calls Confirmation Modal -->
    <div id="batchMakeCallsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Make Calls</h3>
                <button class="modal-close" onclick="closeBatchMakeCallsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; padding: 24px 16px;">
                    <div style="font-size: 48px; margin-bottom: 16px;">üìû</div>
                    <h4 style="margin: 0 0 8px 0; color: #1f2937;">Initiate <span id="makeCallsCount"></span> call(s)?</h4>
                    <p style="margin: 8px 0 0 0; color: #666; font-size: 14px;">Calls will be initiated one after another.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeBatchMakeCallsModal()">Cancel</button>
                <button class="modal-btn primary" onclick="confirmBatchMakeCalls()">Make Calls</button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <img src="https://nmshealth.com/wp-content/uploads/2021/12/nms-health-logo-white-18-300x84.png" alt="NMS Health Logo" class="footer-logo">
    </footer>

    <script src="/scripts/config.js?v=20250109-7"></script>
    <script src="/scripts/dashboard.js?v=20250204-1"></script>
</body>
</html>
