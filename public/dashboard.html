<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Active Calls</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="/styles/monitor.css">
</head>
<body>
    <div class="top-bar">
        <a href="/dashboard.html" class="top-bar-title-link"><h1 class="top-bar-title">AI Active Calls</h1></a>
        <div class="top-bar-right">
            <div class="connection-status" id="connectionStatus">
                <span class="status-dot"></span>
                <span class="status-text">Connecting...</span>
            </div>
            <span class="user-email" id="userEmailDash">-</span>
            <button class="logout-btn" onclick="logout()">Sign Out</button>
        </div>
    </div>
    
    <div class="dashboard-container authenticated">
        <div class="dashboard-content">
            <div class="dashboard-controls">
                <div class="left-controls">
                    <div class="filters-container">
                    <!-- Workflow Status Filter -->
                    <div class="filter-group">
                        <label class="filter-label">Status:</label>
                        <div class="dropdown-filter">
                            <button class="dropdown-toggle" id="statusFilterToggle">
                                <span class="filter-text">All Statuses</span>
                                <span class="dropdown-arrow">‚ñº</span>
                            </button>
                            <div class="dropdown-menu" id="statusFilterMenu">
                                <label class="dropdown-item">
                                    <input type="checkbox" value="all" checked> All
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="pending"> Pending
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="new"> New
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="ready_to_call"> Ready to Call
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="calling"> Calling
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="classifying"> Classifying
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="completed"> Completed
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="failed"> Failed
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="retry_pending"> Retry Pending
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Appointment Range Filter -->
                    <div class="filter-group">
                        <label class="filter-label">Appointment:</label>
                        <div class="dropdown-filter">
                            <button class="dropdown-toggle" id="dateFilterToggle">
                                <span class="filter-text">All Dates</span>
                                <span class="dropdown-arrow">‚ñº</span>
                            </button>
                            <div class="dropdown-menu" id="dateFilterMenu">
                                <label class="dropdown-item">
                                    <input type="checkbox" value="all" checked> All Dates
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="today"> Today
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="tomorrow"> Tomorrow
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="yesterday"> Yesterday
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="last7days"> Last 7 Days
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="last30days"> Last 30 Days
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="older30days"> Older than 30 Days
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Task Type Filter -->
                    <div class="filter-group">
                        <label class="filter-label">Task:</label>
                        <div class="dropdown-filter">
                            <button class="dropdown-toggle" id="taskFilterToggle">
                                <span class="filter-text">All Tasks</span>
                                <span class="dropdown-arrow">‚ñº</span>
                            </button>
                            <div class="dropdown-menu" id="taskFilterMenu">
                                <label class="dropdown-item">
                                    <input type="checkbox" value="all" checked> All Tasks
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="records_request"> Records Request
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="schedule"> Schedule
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="kit_confirmation"> Kit Confirmation
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Active/Inactive Filter -->
                    <div class="filter-group">
                        <label class="filter-label">Archive:</label>
                        <div class="dropdown-filter">
                            <button class="dropdown-toggle" id="activeFilterToggle">
                                <span class="filter-text">Active Only</span>
                                <span class="dropdown-arrow">‚ñº</span>
                            </button>
                            <div class="dropdown-menu" id="activeFilterMenu">
                                <label class="dropdown-item">
                                    <input type="checkbox" value="active" checked> Active
                                </label>
                                <label class="dropdown-item">
                                    <input type="checkbox" value="inactive"> Inactive
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                    <!-- Filter Presets Section -->
                    <div class="filter-presets-section">
                        <button class="save-filter-btn" onclick="showSaveFilterModal()">Save Filter</button>
                        <div class="saved-presets" id="savedPresets">
                            <!-- Saved filter presets will appear here -->
                        </div>
                    </div>
                </div>
                
                <!-- Search Section -->
                <div class="search-section">
                    <div style="display: flex; gap: 10px;">
                        <button class="refresh-btn new-call-btn" onclick="showNewCallModal()">+ New Call</button>
                        <button class="refresh-btn new-call-btn" onclick="showImportModal()">üìÅ Import Calls</button>
                    </div>
                    <div class="search-container">
                        <input type="text" id="searchInput" placeholder="Search calls..." class="search-input">
                        <button class="search-clear" id="searchClear" onclick="clearSearch()" style="display: none;">&times;</button>
                    </div>
                </div>
                
                <!-- Buttons hidden for production
                <button class="refresh-btn" onclick="loadPendingCalls()">Refresh</button>
                <button class="refresh-btn" onclick="testRealtimeConnection()" style="margin-left: 10px;">Test Realtime</button>
                -->
            </div>
            
            <div class="calls-table">
                <table>
                    <thead>
                        <tr>
                            <th>Actions</th>
                            <th data-sort="employee_name" class="sortable">Employee <span class="sort-arrow"></span></th>
                            <th data-sort="appointment_time" class="sortable">Appointment <span class="sort-arrow"></span></th>
                            <th data-sort="task_type" class="sortable">Task <span class="sort-arrow"></span></th>
                            <th data-sort="workflow_state" class="sortable">Status <span class="sort-arrow"></span></th>
                            <th data-sort="success_evaluation" class="sortable">Success <span class="sort-arrow"></span></th>
                            <th data-sort="retry_count" class="sortable">Retries <span class="sort-arrow"></span></th>
                            <th data-sort="client_name" class="sortable">Client <span class="sort-arrow"></span></th>
                            <th data-sort="clinic_name" class="sortable">Clinic <span class="sort-arrow"></span></th>
                            <th data-sort="phone" class="sortable">Phone <span class="sort-arrow"></span></th>
                            <th data-sort="last_attempt_at" class="sortable">Last Try <span class="sort-arrow"></span></th>
                            <th data-sort="next_action_at" class="sortable">Next <span class="sort-arrow"></span></th>
                        </tr>
                    </thead>
                    <tbody id="callsTableBody">
                        <tr>
                            <td colspan="12" class="empty-table">Loading calls...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Save Filter Modal -->
    <div id="saveFilterModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Save Filter Preset</h3>
                <button class="modal-close" onclick="closeSaveFilterModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Give this filter combination a name:</p>
                <input type="text" id="filterPresetName" placeholder="e.g., Today's Failed Calls" maxlength="50">
                <div class="current-filters-preview" id="currentFiltersPreview">
                    <!-- Current filter summary will appear here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeSaveFilterModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveFilterPreset()">Save Preset</button>
            </div>
        </div>
    </div>

    <!-- Classification Editor Modal -->
    <div id="classificationModal" class="modal" style="display: none;">
        <div class="modal-content classification-modal-content">
            <div class="modal-header">
                <h3 id="classificationModalTitle">Edit Classification</h3>
                <button class="modal-close" onclick="closeClassificationModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="classification-form">
                    <!-- Basic Info -->
                    <div class="form-section">
                        <h4>Call Information</h4>
                        <div class="form-group">
                            <label>Phone Number*</label>
                            <input type="text" id="classificationPhone" placeholder="+1234567890" required>
                        </div>
                        <div class="form-group">
                            <label>Clinic Name</label>
                            <input type="text" id="classificationClinicName" placeholder="Enter clinic name">
                        </div>
                    </div>

                    <!-- Classification Type -->
                    <div class="form-section">
                        <h4>Classification Type*</h4>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="classificationType" value="human">
                                <div class="radio-content">
                                    <span class="radio-label">Human</span>
                                    <span class="radio-desc">Direct human answer, no IVR</span>
                                </div>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="classificationType" value="ivr_only">
                                <div class="radio-content">
                                    <span class="radio-label">IVR Only</span>
                                    <span class="radio-desc">Full IVR system requiring navigation</span>
                                </div>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="classificationType" value="ivr_then_human">
                                <div class="radio-content">
                                    <span class="radio-label">IVR Then Human</span>
                                    <span class="radio-desc">IVR greeting then transfers to human</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- IVR Actions (shown only for ivr_only and ivr_then_human) -->
                    <div class="form-section" id="ivrActionsSection" style="display: none;">
                        <h4>IVR Actions</h4>
                        <p class="section-description">Define the navigation sequence through the IVR menu</p>
                        <div id="ivrActionsList"></div>
                        <button type="button" class="add-action-btn" onclick="addIvrAction()">+ Add Action</button>
                    </div>

                    <!-- Confidence Score -->
                    <div class="form-section">
                        <h4>Confidence Score</h4>
                        <div class="form-group">
                            <input type="range" id="classificationConfidence" min="0" max="1" step="0.05" value="0.95">
                            <span id="confidenceValue">0.95</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeClassificationModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveClassification()" id="saveClassificationBtn">Save Classification</button>
            </div>
        </div>
    </div>

    <!-- New Pending Call Modal -->
    <div id="newCallModal" class="modal" style="display: none;">
        <div class="modal-content classification-modal-content">
            <div class="modal-header">
                <h3>New Pending Call</h3>
                <button class="modal-close" onclick="closeNewCallModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="classification-form">
                    <!-- Employee Information -->
                    <div class="form-section">
                        <h4>Employee Information</h4>
                        <div class="form-group">
                            <label>Exam ID*</label>
                            <input type="text" id="newCallExamId" placeholder="Enter exam ID" required>
                        </div>
                        <div class="form-group">
                            <label>Employee Name*</label>
                            <input type="text" id="newCallEmployeeName" placeholder="Enter employee name" required>
                        </div>
                        <div class="form-group">
                            <label>Employee Date of Birth*</label>
                            <input type="date" id="newCallEmployeeDob" required>
                        </div>
                        <div class="form-group">
                            <label>Client Name*</label>
                            <input type="text" id="newCallClientName" placeholder="Enter client name" required>
                        </div>
                    </div>

                    <!-- Appointment Information -->
                    <div class="form-section">
                        <h4>Appointment Information</h4>
                        <div class="form-group">
                            <label>Appointment Time*</label>
                            <input type="datetime-local" id="newCallAppointmentTime" required>
                        </div>
                        <div class="form-group">
                            <label>Type of Visit*</label>
                            <select id="newCallTypeOfVisit" required>
                                <option value="">Select type...</option>
                                <option value="appointment">Appointment</option>
                                <option value="walk-in">Walk-in</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Procedures</label>
                            <textarea id="newCallProcedures" placeholder="Enter procedures" rows="3"></textarea>
                        </div>
                    </div>

                    <!-- Clinic Information -->
                    <div class="form-section">
                        <h4>Clinic Information</h4>
                        <div class="form-group">
                            <label>Clinic Name*</label>
                            <input type="text" id="newCallClinicName" placeholder="Enter clinic name" required>
                        </div>
                        <div class="form-group">
                            <label>Clinic Phone Number*</label>
                            <input type="tel" id="newCallPhone" placeholder="+16095550123" required>
                            <small style="color: #666; font-size: 12px;">Format: +16095550123</small>
                        </div>
                        <div class="form-group">
                            <label>Clinic Provider Address</label>
                            <input type="text" id="newCallClinicAddress" placeholder="Enter clinic address">
                        </div>
                        <div class="form-group">
                            <label>Clinic Timezone*</label>
                            <select id="newCallClinicTimezone" required>
                                <option value="America/New_York">Eastern (America/New_York)</option>
                                <option value="America/Chicago">Central (America/Chicago)</option>
                                <option value="America/Denver">Mountain (America/Denver)</option>
                                <option value="America/Los_Angeles">Pacific (America/Los_Angeles)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Task Information -->
                    <div class="form-section">
                        <h4>Task Information</h4>
                        <div class="form-group">
                            <label>Task Type*</label>
                            <select id="newCallTaskType" required>
                                <option value="records_request">Records Request</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeNewCallModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveNewCall()" id="saveNewCallBtn">Create Call</button>
            </div>
        </div>
    </div>

    <!-- Import Calls Modal -->
    <div id="importModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
            <div class="modal-header">
                <h3 id="importModalTitle">Import Calls</h3>
                <button class="modal-close" onclick="closeImportModal()">&times;</button>
            </div>
            <div class="modal-body" style="overflow-y: auto;">

                <!-- Step 1: File Upload -->
                <div id="importStep1" class="import-step">
                    <h4>Step 1: Upload File</h4>
                    <p style="color: #666; margin-bottom: 16px;">Upload an .xlsx or .csv file containing call data</p>
                    <div class="file-upload-area" id="fileUploadArea">
                        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;" onchange="handleFileUpload(event)">
                        <div class="upload-prompt" onclick="document.getElementById('fileInput').click()">
                            <div style="font-size: 48px; margin-bottom: 12px;">üìÅ</div>
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Click to browse or drag & drop</div>
                            <div style="font-size: 14px; color: #666;">Supports .xlsx, .xls, .csv files</div>
                        </div>
                    </div>
                    <div id="fileInfo" style="display: none; margin-top: 16px; padding: 12px; background: #f0f9ff; border-radius: 6px; border: 1px solid #bae6fd;">
                        <div style="font-weight: 600; margin-bottom: 4px;">File loaded:</div>
                        <div id="fileName" style="color: #666;"></div>
                        <div id="fileStats" style="color: #666; margin-top: 4px;"></div>
                    </div>
                </div>

                <!-- Step 2: Column Mapping -->
                <div id="importStep2" class="import-step" style="display: none;">
                    <h4>Step 2: Map Columns</h4>
                    <p style="color: #666; margin-bottom: 16px;">Match your file columns to database fields</p>
                    <div id="columnMappingContainer"></div>
                </div>

                <!-- Processing Step (shown while detecting timezones) -->
                <div id="importStepProcessing" class="import-step" style="display: none;">
                    <div style="text-align: center; padding: 48px 24px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üåç</div>
                        <h4 style="margin-bottom: 8px;">Processing Data...</h4>
                        <p id="processingMessage" style="color: #666;">Detecting timezones from addresses...</p>
                    </div>
                </div>

                <!-- Step 3: Row Selection -->
                <div id="importStep3" class="import-step" style="display: none;">
                    <h4>Step 3: Select Rows to Import</h4>
                    <p style="color: #666; margin-bottom: 16px;">Choose which rows you want to import</p>
                    <div style="margin-bottom: 12px;">
                        <button class="modal-btn secondary" onclick="selectAllRows()">Select All</button>
                        <button class="modal-btn secondary" onclick="selectNoneRows()">Select None</button>
                        <span id="selectionCount" style="margin-left: 12px; color: #666;"></span>
                    </div>
                    <div id="rowSelectionContainer" style="max-height: 400px; overflow-y: auto;"></div>
                </div>

                <!-- Step 4: Preview -->
                <div id="importStep4" class="import-step" style="display: none;">
                    <h4>Step 4: Preview & Validate</h4>
                    <p style="color: #666; margin-bottom: 16px;">Review data before importing</p>
                    <div id="validationSummary" style="margin-bottom: 16px;"></div>
                    <div id="previewContainer" style="max-height: 400px; overflow-y: auto;"></div>
                </div>

                <!-- Step 5: Import Progress -->
                <div id="importStep5" class="import-step" style="display: none;">
                    <h4>Importing...</h4>
                    <div id="importProgress" style="margin: 32px 0;">
                        <div style="background: #e5e7eb; border-radius: 8px; height: 24px; overflow: hidden; margin-bottom: 12px;">
                            <div id="progressBar" style="background: #10b981; height: 100%; width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <div id="progressText" style="text-align: center; color: #666;"></div>
                    </div>
                    <div id="importResults" style="display: none;"></div>
                </div>

            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" id="importBackBtn" onclick="importPreviousStep()" style="display: none;">Back</button>
                <button class="modal-btn secondary" onclick="closeImportModal()">Cancel</button>
                <button class="modal-btn primary" id="importNextBtn" onclick="importNextStep()">Next</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Delete Call</h3>
                <button class="modal-close" onclick="closeDeleteConfirmation()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; padding: 24px 16px;">
                    <div style="font-size: 48px; color: #dc2626; margin-bottom: 16px;">‚ö†Ô∏è</div>
                    <h4 style="margin: 0 0 8px 0; color: #1f2937;">Are you sure you want to delete this call?</h4>
                    <p id="deleteCallInfo" style="margin: 8px 0 0 0; color: #666; font-size: 14px;"></p>
                    <p style="margin: 16px 0 0 0; color: #dc2626; font-weight: 600; font-size: 14px;">This action cannot be undone.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeDeleteConfirmation()">Cancel</button>
                <button class="modal-btn primary" id="confirmDeleteBtn" onclick="confirmDeleteCall()" style="background-color: #dc2626;">Delete</button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <img src="https://nmshealth.com/wp-content/uploads/2021/12/nms-health-logo-white-18-300x84.png" alt="NMS Health Logo" class="footer-logo">
    </footer>

    <script src="/scripts/config.js?v=20250109-7"></script>
    <script src="/scripts/dashboard.js?v=20250109-7"></script>
</body>
</html>
